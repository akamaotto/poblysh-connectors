# Wire Next.js Demo Tenant Creation to Real API

## Why
The Next.js demo currently provides an incomplete Mode B experience where tenant creation remains mocked even when all other operations use the real API. This creates a disconnect in the user experience and prevents proper demonstration of tenant lifecycle management. The current implementation cannot show realistic tenant isolation, multi-tenancy features, or proper API authentication flows for tenant-scoped operations.

## Summary

This change wires the existing Next.js demo tenant creation UI to the real Rust API when in Mode B (real API mode). Currently, the demo creates mock tenants even when configured to use the real API. This implementation will enable proper tenant registration and mapping between the frontend tenant IDs and the backend `connectorsTenantId`.

## Problem Statement

The Next.js demo currently operates in two modes:
- **Mode A (Mock)**: Uses completely mock data and API responses
- **Mode B (Real)**: Uses the real Connectors API for most operations, **except tenant creation**

When in Mode B, the tenant creation flow still creates mock tenants and stores them in local state. This means:
1. Real API calls don't have proper tenant context
2. The `X-Tenant-Id` header uses mock identifiers
3. No real tenant data is persisted in the backend
4. The demo cannot demonstrate end-to-end tenant lifecycle management

## Proposed Solution

Modify the Next.js demo to detect Mode B and call the real Rust API for tenant creation:

1. **API Endpoint**: Add a tenant creation endpoint to the Rust backend
2. **Frontend Integration**: Modify the tenant creation UI to call the real API in Mode B
3. **Tenant Mapping**: Store and display both frontend tenant ID and backend `connectorsTenantId`
4. **Real Tenant Context**: Use the real tenant identifiers for subsequent Mode B API calls

### Key Changes

#### Backend (Rust)
- Add tenant creation endpoint: `POST /api/v1/tenants`
  - **Request Body**: `{"name": "string (required)", "metadata": {...}}`
  - **Response Body**: `{"data": {"id": "UUID", "name": "string", "created_at": "ISO8601", "metadata": {...}}, "meta": {"request_id": "UUID", "timestamp": "ISO8601"}}`
  - **Headers**: `Location: /api/v1/tenants/{id}`, `X-Trace-Id: UUID`
- Implement tenant repository with CRUD operations
- Add tenant creation handler with validation
- Update OpenAPI documentation

#### Frontend (Next.js Demo)
- Modify `SharedBackendClient` to include tenant creation method
  - **Method Signature**: `createTenant(tenant: {name: string, metadata?: object}): Promise<DemoApiResponse<Tenant>>`
  - **Error Handling**: Returns functional Result types with ValidationError (400), AuthenticationError (401/403), NetworkError (5xx)
- Update tenant creation page to detect Mode B and call real API
- Enhance tenant state management to handle both mock and real tenant data
  - **Storage Strategy**: Use Zustand store with localStorage persistence for tenant mapping
  - **Mapping Structure**: `{frontendTenantId: string, connectorsTenantId: string, createdAt: string}`
- Update the tenant mapping visualization to show real IDs
- Add error handling for API failures with user-friendly fallbacks

## Impact Assessment

### Positive Impact
- **Complete Mode B Functionality**: Enables true end-to-end demo with real API
- **Realistic Demonstration**: Shows actual tenant lifecycle management
- **Better Testing**: Allows testing of tenant isolation and multi-tenancy features
- **Production Alignment**: Aligns demo behavior with production tenant creation flow

### Risk Mitigation
- **Backward Compatibility**: Mode A (mock) remains unchanged
- **Graceful Fallback**: API failures fall back to mock mode with clear messaging
- **Validation**: Proper validation of tenant creation requests
- **Security**: Tenant creation follows existing authentication patterns

## Dependencies

### Required
- Existing Rust tenant model (`src/models/tenant.rs`)
- Existing tenant-mapping specification for proper ID handling
- Current authentication middleware in the Rust backend

### Optional
- Enhanced error handling and user feedback
- Tenant management UI improvements
- Additional tenant lifecycle operations (update, delete)

## Technical Implementation Details

### Tenant Mapping Storage
The frontend will maintain a bidirectional mapping between frontend-generated tenant IDs and backend `connectorsTenantId` values:

```typescript
interface TenantMapping {
  frontendTenantId: string;      // Generated by demo
  connectorsTenantId: string;    // UUID from backend
  createdAt: string;             // ISO 8601 timestamp
  name: string;                  // Tenant name
}

interface TenantState {
  currentTenant: Tenant | null;
  tenantMappings: TenantMapping[];
  mode: 'mock' | 'real';
}
```

**Storage Implementation:**
- Primary state: Zustand store for reactive UI updates
- Persistence: localStorage for session continuity
- Fallback: In-memory state if localStorage unavailable
- Migration: Graceful handling of existing mock tenant data

### API Contract Summary
```
POST /api/v1/tenants
Content-Type: application/json
Authorization: Bearer <jwt_token>

Request:
{
  "name": "string (required, max 255)",
  "metadata": {
    "poblysh_tenant_id": "string (optional UUID)",
    "environment": "string (optional enum)",
    ...
  }
}

Response (201):
{
  "data": {
    "id": "string (UUID)",
    "name": "string",
    "created_at": "string (ISO8601)",
    "updated_at": "string (ISO8601)",
    "metadata": {...}
  },
  "meta": {
    "request_id": "string (UUID)",
    "timestamp": "string (ISO8601)"
  }
}
```

## Success Criteria

1. **Functional Integration**: Mode B creates real tenants in the backend database
2. **Proper ID Mapping**: Frontend correctly displays both tenant IDs and their mapping using the TenantMapping structure
3. **API Consistency**: Subsequent API calls use the real `connectorsTenantId` from stored mappings
4. **Error Handling**: Graceful handling of API failures with functional Result types and user-friendly fallbacks
5. **Backward Compatibility**: Mode A continues to work without any changes
6. **State Persistence**: Tenant mappings survive page refreshes and browser sessions via localStorage
7. **Documentation**: Updated documentation for the new tenant creation flow and storage strategy

## Implementation Approach

The implementation will follow these phases:
1. **Backend API**: Implement tenant creation endpoint
2. **Frontend Integration**: Update demo to call real API in Mode B
3. **State Management**: Enhance tenant state handling
4. **Error Handling**: Add comprehensive error handling and user feedback
5. **Testing**: Ensure both modes work correctly
6. **Documentation**: Update relevant documentation

This approach ensures a smooth transition from mock to real tenant creation while maintaining the educational value of the demo.